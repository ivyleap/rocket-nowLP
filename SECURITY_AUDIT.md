# セキュリティ監査レポート - Rocket Now LP

**監査日**: 2026年1月22日
**対象**: フロントエンド（React/TypeScript）+ バックエンド（Google Apps Script）

---

## 🚨 重大な問題（即座に対応が必要）

### 1. 【重大】機密情報のGit追跡リスク

**問題**: `gas/Code.gs` に機密情報がハードコードされており、Gitにコミットされるリスク

**現在の状況**:
```javascript
const SPREADSHEET_ID = '192-4bW5w7sEPyqXzoCj5M6pTe9CRKG0el0fdbxxElrM';
const CHATWORK_TOKEN = '2aca53a8508294c06127caea7daedccc';
const CHATWORK_ROOM_ID = '409894880';
```

**リスク**:
- Chatwork APIトークンが漏洩すると、第三者がChatworkアカウントを悪用可能
- スプレッドシートIDが漏洩すると、個人情報が閲覧される可能性
- GitHubにpushすると公開リポジトリの場合は即座に全世界に公開

**影響度**: 🔴 **Critical**

**推奨対応**:
1. `.gitignore` に `gas/` フォルダを追加
2. もし既にGitHubにpushしている場合:
   - Chatwork APIトークンを**即座に無効化**して再発行
   - Gitの履歴から機密情報を完全削除（git filter-branch または BFG Repo-Cleaner）

---

### 2. 【重大】GASエンドポイントのレート制限なし

**問題**: doPost関数にレート制限がなく、スパム攻撃やDDoS攻撃に脆弱

**リスク**:
- 悪意のあるボットが大量のリクエストを送信可能
- スプレッドシートが無意味なデータで埋め尽くされる
- Chatworkに大量の通知が送られ、アカウントが制限される可能性
- Google Apps Scriptの実行時間制限に到達

**影響度**: 🔴 **High**

**推奨対応**:
- GAS側でレート制限を実装（IPアドレスまたはセッションベース）
- フロントエンド側でreCAPTCHAまたはhCaptchaを導入
- 短時間に同じIPから複数回送信された場合は拒否

---

### 3. 【重大】入力値のサニタイゼーション不足

**問題**: ユーザー入力がそのままスプレッドシートとChatworkに保存される

**リスク**:
- Chatwork記法インジェクション: `[info]`タグなどを使ってメッセージを改ざん可能
- スプレッドシートに悪意のあるテキストやスクリプトを挿入可能
- 例: `=CMD|'/c calc'!A1` のようなExcel/Sheetsの数式インジェクション

**影響度**: 🟠 **Medium-High**

**推奨対応**:
- 入力値の長さ制限を実装
- 特殊文字のエスケープ処理
- スプレッドシートに保存する際、数式として解釈される文字（`=`, `+`, `-`, `@`）で始まる場合はプレフィックス `'` を追加

---

## ⚠️ 中程度の問題

### 4. 【中】ログに個人情報が記録される

**問題**: Logger.log() で個人情報が記録される

gas/Code.gs:31
```javascript
Logger.log('パース成功: ' + JSON.stringify(data));
```

**リスク**:
- GASの実行ログに個人情報（名前、電話番号、メールアドレス）が記録
- ログは一定期間保持され、スクリプト編集者全員が閲覧可能

**影響度**: 🟡 **Medium**

**推奨対応**:
- 本番環境では個人情報を含むログを削除
- デバッグ用のフラグを設定し、開発時のみログ出力

---

### 5. 【中】CORS設定が不適切

**問題**: フロントエンドで `mode: 'no-cors'` を使用

src/components/CtaSection.tsx:30
```typescript
mode: 'no-cors',
```

**リスク**:
- レスポンスが読めないため、エラーハンドリングが不可能
- 送信が失敗してもユーザーは「成功」と表示される
- セキュリティ上の問題ではないが、UX的に問題

**影響度**: 🟡 **Medium**

**推奨対応**:
- GAS側で適切なCORSヘッダーを返す
- `mode: 'cors'` に変更し、適切なエラーハンドリングを実装

---

### 6. 【中】メールアドレスの検証不足

**問題**: フロントエンド側でHTML5のバリデーションのみ

**リスク**:
- 無効なメールアドレスが保存される可能性
- バックエンド側で検証していないため、APIから直接無効なデータを送信可能

**影響度**: 🟡 **Medium**

**推奨対応**:
- GAS側でメールアドレスの形式を検証
- 電話番号の形式も検証（日本の電話番号フォーマット）

---

## ℹ️ 軽微な問題（改善推奨）

### 7. 【低】エラーメッセージの情報漏洩

**問題**: エラーメッセージに詳細なスタックトレースを返している

gas/Code.gs:64
```javascript
error: error.message
```

**リスク**:
- 内部実装の詳細が漏洩する可能性
- 攻撃者がシステムの構造を理解する手がかりになる

**影響度**: 🟢 **Low**

**推奨対応**:
- 本番環境では汎用的なエラーメッセージを返す
- 詳細なエラーはログにのみ記録

---

### 8. 【低】HTTPSの強制なし

**問題**: GAS URLはHTTPSだが、明示的にHTTPを拒否していない

**影響度**: 🟢 **Low**

**推奨対応**:
- GASは自動的にHTTPSなので問題なし
- ただしフロントエンドのデプロイ時はHTTPSを強制

---

## ✅ 良好な点

1. ✓ ReactでDOMを直接操作していない（XSS対策）
2. ✓ 外部APIキーをフロントエンドに露出していない
3. ✓ 依存パッケージが最新版
4. ✓ TypeScriptで型安全性を確保
5. ✓ GASでmuteHttpExceptionsを使用してエラーハンドリング

---

## 📋 優先順位付きアクションプラン

### 即座に対応（今日中）

1. ✅ `.gitignore` に `gas/` を追加
2. ✅ Gitリポジトリの状態を確認し、機密情報がコミットされていないか確認
3. ✅ もしpush済みならChatwork APIトークンを無効化して再発行

### 本日〜明日中に対応

4. 入力値のサニタイゼーション実装
5. GAS側での入力値検証（メールアドレス、電話番号）
6. 数式インジェクション対策

### 今週中に対応

7. レート制限の実装またはreCAPTCHA導入
8. ログから個人情報を削除
9. 適切なCORS設定とエラーハンドリング

### 余裕があれば対応

10. エラーメッセージの一般化

---

## 🛡️ セキュリティベストプラクティス

### 今後の開発で心がけること

1. **機密情報は絶対にハードコードしない**
   - GASの場合、スクリプトプロパティを使用
   - フロントエンドの場合、環境変数を使用

2. **信頼できないデータは全て検証**
   - ユーザー入力は必ず検証
   - フロントエンドの検証は補助的、バックエンドで必ず再検証

3. **最小権限の原則**
   - APIトークンは必要最小限の権限のみ
   - スプレッドシートは必要な人のみアクセス可能に

4. **定期的なセキュリティレビュー**
   - 依存パッケージの更新
   - APIトークンの定期的な再発行

---

## 📞 緊急時の対応

### もし機密情報が漏洩したら

1. **即座にトークンを無効化**
   - Chatwork APIトークンを削除
   - 新しいトークンを発行

2. **スプレッドシートのアクセス権限を確認**
   - 不正なアクセスがないか確認
   - 必要に応じて新しいスプレッドシートに移行

3. **Gitの履歴をクリーン**
   - BFG Repo-Cleanerで機密情報を削除
   - force pushで履歴を上書き

---

**総合評価**: 🟡 **要改善**

基本的な実装は問題ありませんが、機密情報の管理とレート制限が不十分です。
上記のアクションプランに従って、優先度の高い項目から対応してください。
